generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// プラン
model MPlan {
  id            Int      @id @default(autoincrement()) // 1: 無料版, 2: 有料版
  name          String   @db.VarChar(25)
  description   String   @db.Text
  price         Int
  stripePriceId String?  @db.VarChar(255) // Stripe Price ID (price_xxx)。無料プランはnull
  createdAt     DateTime @default(now())

  users TUser[]

  @@map("m_plan")
}

/// モデル
model MModel {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String   @db.Text
  modelId     String   @unique @db.VarChar(100) // API に渡すモデルID (例: "gemini-2.0-flash")
  provider    String   @db.VarChar(50) // "gemini" | "groq"
  color       String   @db.VarChar(7) // example: #RRGGBB
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  chatSessions TChatSession[]

  @@map("m_model")
}

/// ユーザー
model TUser {
  id          Int      @id @default(autoincrement())
  authId String   @unique @db.VarChar(255) // Clerk認証との紐付け
  name        String   @db.VarChar(100)
  email       String   @unique @db.VarChar(255)
  imageUrl    String?  @db.VarChar(500) // プロフィール画像URL
  planId               Int
  stripeSubscriptionId String?  @unique @db.VarChar(255) // Stripe Subscription ID (sub_xxx)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  plan           MPlan            @relation(fields: [planId], references: [id])
  stripeCustomer TStripeCustomer?
  chatSessions   TChatSession[]

  @@map("t_user")
}

/// Stripe顧客情報
model TStripeCustomer {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  stripeCustomerId String   @unique @db.VarChar(255) // Stripe Customer ID (cus_xxx)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user TUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("t_stripe_customer")
}

/// チャットセッション
model TChatSession {
  id        String   @id @default(cuid())
  userId    Int
  modelId   Int
  title     String   @db.VarChar(255) // デフォルト: "新しいチャット"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     TUser          @relation(fields: [userId], references: [id], onDelete: Cascade)
  model    MModel         @relation(fields: [modelId], references: [id])
  messages TChatHistory[]

  @@map("t_chat_session")
}

/// チャット履歴
model TChatHistory {
  id           Int      @id @default(autoincrement())
  sessionId    String
  role         String   @db.VarChar(20) // "user" | "assistant"
  content      String   @db.Text
  inputTokens  Int? // LLM へ送信したトークン数。assistantメッセージ行のみ格納
  outputTokens Int? // LLM から返ってきたトークン数。assistantメッセージ行のみ格納
  createdAt    DateTime @default(now())

  session TChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("t_chat_history")
}